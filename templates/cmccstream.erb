; BEGIN CMCC ALARM RULE

(where (not (state "expired"))
<% if @host_regex -%>
  (where (host #"<%= @host_regex %>")
<% end -%>
    (by :host
<% if @alarm_conditions -%>
  <% @alarm_conditions.each_value do |value| -%>
      (where (service "<%= value["name"] %>")
    <% if @time_length -%>
        (fixed-time-window <%= @time_length %>
          (smap (fn [events] (let [fraction (/ (count (filter #(<% if value["indicators"].size == 2 -%><%= value["operation"] %> <%= value["indicators"][0] %> (:metric %) <%= value["indicators"][1] %><% else -%><%= value["operation"] %> (:metric %) <%= value["indicators"] %><% end -%>) events)) (count events))]
                  (event {:service "<%= value["name"] %>"
                          :host (:host events)
                          :metric fraction
                          ;:time (unix-time)
                          :description (str fraction "(*100)%  <%= value["name"] %> metric <% if value["indicators"].size == 2 -%>in range <%= value["indicators"][0] %> ~ <%= value["indicators"][1] %><% else -%><%= value["operation"] %> <%= value["indicators"] %><% end -%> in the last <%= @time_length %> seconds")
                           :state   (condp < fraction
                                     0.9 "critical"
                                     0.7 "warning"
                                         "ok")})))
                 (where (state "critical")
    <% else -%>
        (where (<% if value["indicators"].size == 2 -%><%= value["operation"] %> <%= value["indicators"][0] %> metric <%= value["indicators"][1] %><% else -%><%= value["operation"] %> metric <%= value["indicators"] %><% end -%>)
    <% end -%>
    <% if @time_granularity -%>
                   (throttle 1 <%= @time_granularity %>
    <% end -%>
                     ((mailer {:from <% if @mail_from -%>"<%= @mail_from %>"<% end -%>}) <% if @mail_to -%>"<%= @mail_to %>"<% end -%>)
    <% if @time_granularity -%>
                   )
    <% end -%>
    <% if @time_length -%>
        )))
    <% else -%>
        )
    <% end -%>
      )
  <% end -%>
<% end -%>
    )
<% if @host_regex -%>
  )
<% end -%>
)

; END CMCC ALARM RULE
