; BEGIN CMCC ALARM RULE

(where (not (state "expired"))
<% if @host_regex -%>
  (where (host #"<%= @host_regex %>")
<% end -%>
    (by :host
<% if @alarm_conditions -%>
  <% @alarm_conditions.each_value do |value| -%>
      (where (service "<%= value["name"] %>")
    <% if @time_length > "0" -%>
        (fixed-time-window <%= @time_length %>
          (smap folds/minimum
            (where (<% if value["indicators"].size == 2 -%><%= value["operation"] %> <%= value["indicators"][0] %> metric <%= value["indicators"][1] %><% else -%><%= value["operation"] %> metric <%= value["indicators"][0] %><% end -%>)
              (adjust [:description str "\n or more in the last <%= @time_length %> seconds"]
    <% else -%>
        (where (<% if value["indicators"].size == 2 -%><%= value["operation"] %> <%= value["indicators"][0] %> metric <%= value["indicators"][1] %><% else -%><%= value["operation"] %> metric <%= value["indicators"][0] %><% end -%>)
    <% end -%>
    <% if @time_granularity > "0" -%>
                   (throttle 1 <%= @time_granularity %>
    <% end -%>
                     ((mailer {:from <% if @mail_from -%>"<%= @mail_from %>"<% end -%>}) <% if @mail_to -%>"<%= @mail_to %>"<% end -%>)
    <% if @time_granularity > "0" -%>
                   )
    <% end -%>
    <% if @time_length > "0" -%>
        ))))
    <% else -%>
        )
    <% end -%>
      )
  <% end -%>
<% end -%>
    )
<% if @host_regex -%>
  )
<% end -%>
)

; END CMCC ALARM RULE
